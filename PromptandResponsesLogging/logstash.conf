input {
  file {
    path => "/usr/share/logstash/logs/llm_logs.json"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    type => "llm_log"
  }
}

filter {
  if [type] == "llm_log" {
    # Parse the timestamp field
    date {
      match => ["timestamp", "ISO8601"]
    }
    
    # Add computed fields for analytics
    mutate {
      add_field => { "prompt_length" => "%{[prompt]}" }
      add_field => { "response_length" => "%{[response]}" }
    }
    
    # Calculate string lengths using Ruby
    ruby {
      code => "
        event.set('prompt_length', event.get('prompt').to_s.length)
        event.set('response_length', event.get('response').to_s.length)
        event.set('total_length', event.get('prompt_length') + event.get('response_length'))
      "
    }
    
    # Extract tokens if available in metadata
    if [tokens_used] {
      mutate {
        convert => { "tokens_used" => "integer" }
      }
    }
    
    # Extract latency if available in metadata
    if [latency_ms] {
      mutate {
        convert => { "latency_ms" => "float" }
      }
    }
    
    # Add hour of day for time-based analysis
    ruby {
      code => "
        event.set('hour_of_day', Time.parse(event.get('timestamp')).hour)
      "
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "llm-logs-%{+YYYY.MM.dd}"
  }
  
  # Output to stdout for debugging
  stdout { 
    codec => rubydebug 
  }
}